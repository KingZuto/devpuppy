version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing dependencies..."
      - echo "Current directory:" && pwd
      - echo "Directory contents:" && ls -la
      - echo "App directory contents:"
      - ls -la app/
      - echo "Installing with npm ci..."
      - cd app && npm ci --verbose
  pre_build:
    commands:
      - echo "Pre-build phase started on `date`"
      - echo "Current directory:" && pwd
      - echo "Checking Node.js and npm versions"
      - cd $CODEBUILD_SRC_DIR/app && node --version && npm --version
      - echo "Checking package.json:"
      - cd $CODEBUILD_SRC_DIR/app && cat package.json
      - echo "Determining environment..."
      - |
        # Get environment from CodeBuild environment variable or default to dev
        ENVIRONMENT=${ENVIRONMENT:-dev}
        echo "ðŸŒ Using environment: $ENVIRONMENT"
      - echo "Getting API Gateway URL from Parameter Store..."
      - |
        # Try to get API Gateway URL from Parameter Store (environment-aware)
        CONTACT_API_ENDPOINT=$(aws ssm get-parameter --name "/devpuppy/$ENVIRONMENT/contact-api-endpoint" --region ap-northeast-2 --query "Parameter.Value" --output text 2>/dev/null || echo "")
        
        if [ ! -z "$CONTACT_API_ENDPOINT" ] && [ "$CONTACT_API_ENDPOINT" != "None" ]; then 
          export NEXT_PUBLIC_CONTACT_API_ENDPOINT="$CONTACT_API_ENDPOINT"
          echo "âœ… Got API endpoint from Parameter Store: $NEXT_PUBLIC_CONTACT_API_ENDPOINT"
        else 
          echo "âš ï¸  Parameter Store not available, trying API Gateway discovery..."
          API_ID=$(aws apigateway get-rest-apis --region ap-northeast-2 --query "items[?contains(name, 'devpuppy-$ENVIRONMENT-contact-api')].id" --output text)
          echo "Found API Gateway ID: $API_ID"
          if [ ! -z "$API_ID" ] && [ "$API_ID" != "None" ]; then 
            export NEXT_PUBLIC_CONTACT_API_ENDPOINT="https://$API_ID.execute-api.ap-northeast-2.amazonaws.com/$ENVIRONMENT/send-email"
            echo "âœ… Set fallback API endpoint: $NEXT_PUBLIC_CONTACT_API_ENDPOINT"
          else 
            echo "âŒ Could not determine API Gateway URL for environment: $ENVIRONMENT"
            echo "âš ï¸  Continuing without API endpoint (contact form will not work)"
            export NEXT_PUBLIC_CONTACT_API_ENDPOINT=""
          fi
        fi
      - echo "Creating .env.production file..."
      - cd $CODEBUILD_SRC_DIR/app && echo "NEXT_PUBLIC_CONTACT_API_ENDPOINT=$NEXT_PUBLIC_CONTACT_API_ENDPOINT" > .env.production
      - echo "Environment file contents:" && cat .env.production
  build:
    commands:
      - echo "Build phase started on `date`"
      - echo "Current directory:" && pwd
      - echo "Building Next.js application..."
      - cd $CODEBUILD_SRC_DIR/app && npm run build --verbose
      - echo "Build completed, checking output:"
      - cd $CODEBUILD_SRC_DIR/app && ls -la out/
  post_build:
    commands:
      - echo "Post-build phase started on `date`"
      - echo "Current directory:" && pwd
      - echo "Syncing files to S3 bucket $S3_BUCKET"
      - aws s3 sync $CODEBUILD_SRC_DIR/app/out/ s3://$S3_BUCKET --delete
      - echo "Creating CloudFront invalidation for distribution $CLOUDFRONT_DISTRIBUTION_ID"
      - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
      - echo "Deployment completed successfully"

artifacts:
  files:
    - '**/*'
  base-directory: app/out
  name: website-build

cache:
  paths:
    - app/node_modules/**/*
